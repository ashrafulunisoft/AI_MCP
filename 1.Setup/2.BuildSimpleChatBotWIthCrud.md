Perfect! üî• We‚Äôre now building a **full-featured Laravel AI chatbot** that:

* Uses **Ollama Pi model** (local in Docker)
* Keeps **conversation memory** in Redis
* Stores **chat logs** in MySQL
* Supports **CRUD operations** (Orders, Packages, Claims)
* Uses **intent detection via JSON**
* Optionally can be upgraded to **MCP server**
* Has a **frontend chat UI with live updates**

We‚Äôll do this **step by step**, clean and modular.

---

# **Step 1: DB & Models**

We already have `chats` table. Now add **Packages, Orders, Claims**.

---

### Packages Migration

```bash
php artisan make:migration create_packages_table --create=packages
```

```php
Schema::create('packages', function (Blueprint $table) {
    $table->id();
    $table->string('name');
    $table->text('description')->nullable();
    $table->decimal('price', 10, 2);
    $table->timestamps();
});
```

---

### Orders Migration

```bash
php artisan make:migration create_orders_table --create=orders
```

```php
Schema::create('orders', function (Blueprint $table) {
    $table->id();
    $table->unsignedBigInteger('user_id');
    $table->unsignedBigInteger('package_id');
    $table->enum('status', ['pending','completed','cancelled'])->default('pending');
    $table->timestamps();
});
```

---

### Claims Migration

```bash
php artisan make:migration create_claims_table --create=claims
```

```php
Schema::create('claims', function (Blueprint $table) {
    $table->id();
    $table->unsignedBigInteger('user_id');
    $table->text('description');
    $table->enum('status', ['pending','approved','rejected'])->default('pending');
    $table->timestamps();
});
```

```bash
php artisan migrate
```

---

# **Step 2: Update Chatbot Service with Intent Detection & CRUD**

### `app/Services/ChatbotService.php`

```php
<?php

namespace App\Services;

use Illuminate\Support\Facades\Http;
use Illuminate\Support\Facades\Redis;
use App\Models\Chat;
use App\Models\Package;
use App\Models\Order;
use App\Models\Claim;
use Illuminate\Support\Facades\Auth;

class ChatbotService
{
    protected $redisPrefix = 'chat_memory:';

    public function chat($userMessage)
    {
        $user = Auth::user();
        $userId = $user->id ?? 'guest';

        // Load previous messages
        $redisKey = $this->redisPrefix . $userId;
        $history = Redis::get($redisKey);
        $history = $history ? json_decode($history, true) : [];

        // Add user message
        $history[] = ['role'=>'user','content'=>$userMessage];

        // System prompt with intent rules
        $systemMessage = [
            'role'=>'system',
            'content'=> "
You are a smart insurance assistant. Use JSON intent to respond.

Intent JSON schema:
{
  \"intent\": \"list_packages | create_order | submit_claim | get_user_info | faq | unknown\",
  \"data\": {}
}

Rules:
- If user asks about packages ‚Üí intent: list_packages
- If user wants to create order ‚Üí intent: create_order (data.package_id)
- If user wants to submit claim ‚Üí intent: submit_claim (data.description)
- If user asks about themselves ‚Üí intent: get_user_info
- If user asks FAQ ‚Üí intent: faq
- Reply in Bangla if user writes Bangla
- Reply in English if user writes English
- Include user info if intent requires it
"
        ];

        // Call Ollama local Pi model
        $response = Http::post('http://localhost:11434/api/chat', [
            'model' => 'pi',
            'messages' => array_merge([$systemMessage], $history),
        ])->json();

        $botContent = $response['choices'][0]['message']['content'] ?? '{}';

        // Try decode JSON for intent
        $intentData = json_decode($botContent, true) ?? ['intent'=>'unknown','data'=>[]];

        // Handle CRUD based on intent
        $replyText = $this->handleIntent($intentData, $user);

        // Save to Redis
        $history[] = ['role'=>'assistant','content'=>$replyText];
        Redis::set($redisKey, json_encode(array_slice($history, -20)));

        // Save to DB
        Chat::create([
            'user_id'=>$user->id ?? null,
            'user_message'=>$userMessage,
            'bot_message'=>$replyText
        ]);

        return $replyText;
    }

    protected function handleIntent($intentData, $user)
    {
        $intent = $intentData['intent'] ?? 'unknown';
        $data = $intentData['data'] ?? [];

        switch($intent)
        {
            case 'list_packages':
                $packages = Package::all()->map(fn($p)=> $p->name)->toArray();
                return "Available packages: " . implode(', ',$packages);

            case 'create_order':
                if(!isset($data['package_id'])) return "Package ID missing.";
                $order = Order::create([
                    'user_id'=>$user->id,
                    'package_id'=>$data['package_id']
                ]);
                return "Order #{$order->id} created successfully!";

            case 'submit_claim':
                if(!isset($data['description'])) return "Claim description missing.";
                $claim = Claim::create([
                    'user_id'=>$user->id,
                    'description'=>$data['description']
                ]);
                return "Claim #{$claim->id} submitted successfully!";

            case 'get_user_info':
                return "Name: {$user->name}, Email: {$user->email}, User ID: {$user->id}";

            case 'faq':
                return $data['answer'] ?? "FAQ answer not found.";

            default:
                return "Sorry, I could not understand your request.";
        }
    }
}
```

‚úÖ Now the **AI can trigger CRUD operations** via JSON intents.

---

# **Step 3: Controller**

### `app/Http/Controllers/ChatController.php`

```php
<?php

namespace App\Http\Controllers;

use Illuminate\Http\Request;
use App\Services\ChatbotService;

class ChatController extends Controller
{
    public function chat(Request $request, ChatbotService $chatbot)
    {
        $request->validate(['message'=>'required|string']);
        $reply = $chatbot->chat($request->message);
        return response()->json(['user'=>$request->message,'bot'=>$reply]);
    }
}
```

---

# **Step 4: Route**

```php
Route::middleware('auth')->post('/chatbot', [ChatController::class,'chat']);
```

---

# **Step 5: Frontend Chat UI with Live Updates**

You can use **Blade + AlpineJS + Axios**.

### `resources/views/chat.blade.php`

```html
<div id="chat" class="p-4 max-w-md mx-auto">
  <div id="messages" class="mb-4 h-64 overflow-y-auto border p-2 rounded"></div>

  <input type="text" id="userMessage" class="border p-2 w-full" placeholder="Type message..." />
  <button id="sendBtn" class="bg-blue-500 text-white p-2 mt-2 w-full">Send</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
const messagesDiv = document.getElementById('messages');
const input = document.getElementById('userMessage');

document.getElementById('sendBtn').onclick = async () => {
    const msg = input.value.trim();
    if(!msg) return;
    messagesDiv.innerHTML += `<div><b>You:</b> ${msg}</div>`;
    input.value = '';

    try {
        const res = await axios.post('/chatbot', {message: msg});
        messagesDiv.innerHTML += `<div><b>Bot:</b> ${res.data.bot}</div>`;
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    } catch(e) {
        messagesDiv.innerHTML += `<div><b>Bot:</b> Error occurred</div>`;
    }
};
</script>
```

---

# **Step 6: Testing**

1. Login as a user (auth required)
2. Open `/chat` Blade page
3. Type messages like:

   * ‚Äú‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ï‡ßã‡¶® package ‡¶Ü‡¶õ‡ßá?‚Äù ‚Üí lists packages
   * ‚ÄúCreate order for package 2‚Äù ‚Üí creates order
   * ‚ÄúSubmit claim for broken item‚Äù ‚Üí creates claim
   * ‚ÄúWho am I?‚Äù ‚Üí shows user info

‚úÖ Everything saved in **MySQL** and **Redis memory** is maintained per user.

---

# ‚úÖ Optional Upgrade: MCP Server Version

If you want structured AI integration (for multi-agents or external AI clients), we can:

1. Create `ChatServer` (MCP Server)
2. Move `ChatbotService` logic into **Tools + Prompts**
3. Expose `/mcp/chat` endpoint
4. AI clients can call it via MCP protocol

---

This setup gives you:

* **Persistent memory** with Redis
* **Database logs** for audit
* **Intent detection** for CRUD
* **Frontend live chat**
* **Ollama Pi local model**

---

I can now provide the **full MCP server version with Tools, Prompts, and Resources**, so any AI agent (ChatGPT, Claude, etc.) can call your Laravel chatbot via MCP protocol directly.

Do you want me to do that next?
